@model talim_platforma.Models.ViewModels.StudentDashboardViewModel
@{
    Layout = "~/Views/Shared/_TalabaLayout.cshtml";
    ViewData["Title"] = "Talaba kabineti";
}

<div class="max-w-7xl mx-auto space-y-6">
    <!-- Reklama qismi -->
    <div class="w-full">
        @await Component.InvokeAsync("Ads", new { target = "student" })
    </div>
    
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <p class="text-sm text-gray-500">Assalomu alaykum</p>
            <h1 class="text-2xl font-bold text-gray-800">@Model.FullName</h1>
            <p class="mt-2 text-gray-500">Bugungi sana: @DateTime.Now.ToString("dd MMMM, yyyy")</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <a asp-controller="Oquvchi" asp-action="DashboardTalaba" asp-fragment="imtihonlar"
               class="px-5 py-2.5 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors">
                 Imtihonlarim
            </a>
            <a asp-controller="Imtihon" asp-action="Sertifikatlar"
               class="px-5 py-2.5 rounded-xl bg-gray-100 text-gray-800 text-sm font-semibold hover:bg-gray-200 transition-colors">
                 Natijalar & Sertifikatlar
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
        <div class="bg-white border border-blue-100 rounded-2xl p-5 shadow-sm">
            <p class="text-sm text-gray-500">Faol guruhlar</p>
            <p class="mt-2 text-3xl font-bold text-blue-600">@Model.FaolGuruhlar</p>
        </div>
        <div class="bg-white border border-indigo-100 rounded-2xl p-5 shadow-sm">
            <p class="text-sm text-gray-500">Faol kurslar</p>
            <p class="mt-2 text-3xl font-bold text-indigo-600">@Model.FaolKurslar</p>
        </div>
        <div class="bg-white border border-green-100 rounded-2xl p-5 shadow-sm">
            <p class="text-sm text-gray-500">Jami to'lov</p>
            <p class="mt-2 text-3xl font-bold text-green-600">@Model.JamiTolov.ToString("N0")</p>
        </div>
        <div class="bg-white border border-amber-100 rounded-2xl p-5 shadow-sm">
            <p class="text-sm text-gray-500">Oxirgi imtihon</p>
            <p class="mt-2 text-3xl font-bold text-amber-600">
                @(Model.OxirgiFoiz.HasValue ? $"{Model.OxirgiFoiz:F1}%" : "-")
            </p>
        </div>
        <div class="bg-white border border-purple-100 rounded-2xl p-5 shadow-sm">
            <p class="text-sm text-gray-500"> Tangacha</p>
            <p class="mt-2 text-3xl font-bold text-purple-600">@Model.Tangacha.ToString("N0")</p>
            <p class="text-xs text-gray-400 mt-1">so'm</p>
        </div>
    </div>

    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 space-y-4" id="kurslar">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-800">Kurslarim</h2>
            <span class="text-sm text-gray-500">@Model.Kurslar.Count ta kurs</span>
        </div>
        @if (Model.Kurslar.Any())
        {
            <div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4">
                @foreach (var kurs in Model.Kurslar)
                {
                    var statusClass = kurs.Holati?.ToLower() switch
                    {
                        "haqdor" => "bg-green-100 text-green-700",
                        "qarzdor" => "bg-red-100 text-red-700",
                        "toliq" or "to'liq" => "bg-blue-100 text-blue-700",
                        _ => "bg-gray-100 text-gray-700"
                    };
                    <div class="border rounded-xl p-4 bg-white">
                        <p class="text-sm text-gray-500">Kurs</p>
                        <p class="text-lg font-semibold text-gray-800">@kurs.Nomi</p>
                        <p class="text-sm text-gray-500 mt-1">Narxi: @kurs.Narx.ToString("N0")</p>
                        <span class="inline-flex mt-2 items-center px-2 py-1 rounded-full text-xs font-medium @statusClass">
                            @kurs.Holati
                        </span>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center text-gray-500 py-8 border border-dashed rounded-xl">
                Kurslar ro'yxati topilmadi.
            </div>
        }
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 space-y-4 lg:col-span-2" id="guruhlar">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Guruhlar & jadval</h2>
                <span class="text-sm text-gray-500">@Model.Guruhlar.Count ta guruh</span>
            </div>
            @if (Model.Guruhlar.Any())
            {
                <div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4">
                    @foreach (var card in Model.Guruhlar)
                    {
                        <div class="border rounded-xl p-4 hover:border-blue-400 transition-all bg-white">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <p class="text-sm text-gray-500">@card.Kurs</p>
                                    <p class="text-lg font-semibold text-gray-800">@card.Nomi</p>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700">
                                    @card.TalabalarSoni ta
                                </span>
                            </div>
                            <div class="mt-3 text-sm text-gray-500 space-y-1">
                                <p> @card.DarsVaqti</p>
                                <p> @card.DarsKunlari</p>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center text-gray-500 py-8 border border-dashed rounded-xl">
                    Sizga hali guruh biriktirilmagan.
                </div>
            }
        </div>

        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 space-y-4" id="payments">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">To'lovlar tarixi</h2>
                <span class="text-sm text-gray-500">Qarzdorlik: @Model.Qarzdorlik.ToString("N0") 路 Haqdor: @Model.Haqdorlik.ToString("N0")</span>
            </div>
            @if (Model.Tolovlar.Any())
            {
                <ul class="space-y-3">
                    @foreach (var item in Model.Tolovlar)
                    {
                        <li class="border border-gray-100 rounded-xl p-4 hover:border-blue-200 transition-colors cursor-pointer"
                            onclick="window.location.href='@Url.Action("PaymentHistory", "Oquvchi")'">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-semibold text-gray-800">@item.Kurs</p>
                                    <p class="text-xs text-gray-500">@item.Sana.ToString("dd MMM, yyyy") 路 @item.TolovUsuli</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-green-600 font-semibold">+ @item.Miqdor.ToString("N0")</p>
                                    <p class="text-xs text-gray-500">Qoldiq: @item.Qarzdorlik.ToString("N0")</p>
                                </div>
                            </div>
                            <div class="mt-2 text-sm text-gray-600">
                                <p>Holat: @(!string.IsNullOrWhiteSpace(item.Holat) ? item.Holat : "Hisoblanmoqda")</p>
                                <p>Haqdorlik: @item.Haqdorlik.ToString("N0")</p>
                                <p>Chek raqami: @(!string.IsNullOrWhiteSpace(item.ChekRaqami) ? item.ChekRaqami : "-")</p>
                            </div>
                        </li>
                    }
                </ul>
            }
            else
            {
                <div class="text-center text-gray-500 py-8 border border-dashed rounded-xl">
                    To'lovlar tarixi hali mavjud emas.
                </div>
            }
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="davomat">
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 space-y-4">
            <h2 class="text-lg font-semibold text-gray-800">Davomat tarixi</h2>
            @if (Model.Davomatlar.Any())
            {
                <ul class="space-y-3">
                    @foreach (var item in Model.Davomatlar)
                    {
                        var rang = item.Holati switch
                        {
                            "Keldi" => "text-green-600",
                            "Kech keldi" => "text-amber-500",
                            "Kelmadi" => "text-red-500",
                            _ => "text-gray-600"
                        };
                        <li class="flex items-center justify-between border border-gray-100 rounded-xl p-4">
                            <div>
                                <p class="font-semibold text-gray-800">@item.Guruh</p>
                                <p class="text-xs text-gray-500">@item.Sana.ToString("dd MMM, yyyy")</p>
                            </div>
                            <p class="text-sm font-medium @rang">@item.Holati</p>
                        </li>
                    }
                </ul>
            }
            else
            {
                <div class="text-center text-gray-500 py-8 border border-dashed rounded-xl">
                    Hozircha davomat ma'lumotlari yoq.
                </div>
            }
        </div>

        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 space-y-4" id="imtihonlar">
            <h2 class="text-lg font-semibold text-gray-800">Online imtihonlar</h2>
            @if (Model.OnlineImtihonlar.Any())
            {
                <div class="space-y-3">
                    @foreach (var exam in Model.OnlineImtihonlar)
                    {
                        <div class="border border-gray-100 rounded-xl p-4">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <p class="text-sm text-gray-500">@exam.Kurs</p>
                                    <p class="text-lg font-semibold text-gray-800">@exam.Nomi</p>
                                    <p class="text-xs text-gray-500">@exam.Sana.ToString("dd MMM, yyyy") 路 @(exam.MuddatDaqiqada ?? 60) daqiqa</p>
                                </div>
                                <span class="text-sm text-gray-500">@exam.Guruh</span>
                            </div>
                            <div class="mt-3 flex items-center justify-between">
                                <p class="text-sm @(exam.IsEligible ? "text-green-600" : "text-amber-600")">@exam.EligibilityMessage</p>
                                <a asp-controller="Imtihon" asp-action="OnlineImtihon" asp-route-id="@exam.Id"
                                   class="px-4 py-2 rounded-lg text-sm font-semibold @(exam.IsEligible ? "bg-blue-600 text-white hover:bg-blue-700" : "bg-gray-200 text-gray-500 cursor-not-allowed")"
                                   aria-disabled="@(exam.IsEligible ? "false" : "true")">
                                    Imtihonni boshlash
                                </a>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center text-gray-500 py-8 border border-dashed rounded-xl">
                    Hozircha online imtihonlar mavjud emas.
                </div>
            }
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 space-y-4" id="natijalar">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Imtihon natijalari</h2>
                <a asp-controller="Imtihon" asp-action="Sertifikatlar" class="text-sm text-blue-600 hover:text-blue-700">Barchasini ko'rish</a>
            </div>
            @if (Model.Natijalar.Any())
            {
                <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-4">
                    @foreach (var item in Model.Natijalar)
                    {
                        <div class="border border-gray-100 rounded-xl p-4 space-y-1">
                            <p class="text-sm text-gray-500">@item.Guruh</p>
                            <p class="font-semibold text-gray-800">@item.ImtihonNomi</p>
                            <p class="text-xs text-gray-500">@item.Sana.ToString("dd MMM, yyyy")</p>
                            <p class="text-sm font-medium @(item.Otdimi ? "text-green-600" : "text-red-500")">
                                @item.Foiz.ToString("F1")% 路 @(item.Otdimi ? "O'tdi" : "O'tmadi")
                            </p>
                            <a asp-controller="Imtihon" asp-action="NatijaTafsilot" asp-route-natijaId="@item.NatijaId"
                               class="text-sm text-blue-600 hover:text-blue-700 font-semibold">
                                Tafsilot
                            </a>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center text-gray-500 py-8 border border-dashed rounded-xl">
                    Hozircha imtihon natijalari mavjud emas.
                </div>
            }
        </div>

        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 space-y-4" id="baholar">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800"> Dars baholari</h2>
                <span class="text-sm text-gray-500">@Model.Baholar.Count ta baho</span>
            </div>
            @if (Model.Baholar.Any())
            {
                <div class="space-y-3">
                    @foreach (var baho in Model.Baholar)
                    {
                        var bahoRang = baho.Baho switch
                        {
                            >= 90 => "text-green-600",
                            >= 70 => "text-blue-600",
                            >= 50 => "text-amber-600",
                            _ => "text-red-600"
                        };
                        <div class="border border-gray-100 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">@baho.KursNomi</p>
                                    <p class="font-semibold text-gray-800">@baho.GuruhNomi</p>
                                    <p class="text-xs text-gray-500">@baho.Sana.ToString("dd MMM, yyyy")</p>
                                    <p class="text-xs text-gray-400 mt-1">@baho.Mavzu</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold @bahoRang">@baho.Baho%</p>
                                    <p class="text-xs text-gray-500">Baho</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center text-gray-500 py-8 border border-dashed rounded-xl">
                    Hozircha baholar mavjud emas.
                </div>
            }
        </div>
    </div>
</div>


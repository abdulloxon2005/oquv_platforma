@using talim_platforma.Models
@{
    ViewData["Title"] = "Guruhlar";
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
}

@{
    var guruhlar = ViewBag.Guruhlar as List<Guruh> ?? new List<Guruh>();
    var tanlanganGuruh = ViewBag.TanlanganGuruh as Guruh;
    var talabalar = ViewBag.Talabalar as List<Foydalanuvchi> ?? new List<Foydalanuvchi>();
    var davomatlar = ViewBag.Davomatlar as List<Davomat> ?? new List<Davomat>();
    var darsKunlari = ViewBag.DarsKunlari as List<DateTime> ?? new List<DateTime>();
    var month = (int)ViewBag.Month;
    var year = (int)ViewBag.Year;
    var autoOpenModal = ViewBag.OpenAttendanceModal as bool? ?? false;
    var todayString = DateTime.Today.ToString("yyyy-MM-dd");
}

<style>
    .status-btn {
        border-width: 1px;
        border-color: #e5e7eb;
        color: #6b7280;
        transition: all 0.2s ease;
    }

    .status-btn:hover {
        transform: scale(1.1);
    }

    .status-btn.active {
        border-color: #2563eb;
        background-color: #eff6ff;
        color: #1d4ed8;
        transform: scale(1.05);
    }
    
    .message-box {
        transition: all 0.3s ease;
        animation: slideIn 0.3s ease;
    }
    
    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-radius: 50%;
        border-top-color: #3498db;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .student-row {
        transition: all 0.2s ease;
    }
    
    .student-row:hover {
        background-color: #f8fafc;
        transform: translateY(-1px);
    }
    
    .baho-container {
        animation: fadeIn 0.3s ease;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>

<div class="max-w-7xl mx-auto space-y-6">
    <!-- Header + Actions -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm px-5 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">
                @(tanlanganGuruh?.Nomi ?? "Guruh tanlang")
            </h1>
            @if (tanlanganGuruh != null)
            {
                <p class="mt-1 text-sm text-gray-500 flex items-center gap-2">
                    <span>Guruh ID - #@tanlanganGuruh.Id</span>
                    <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">
                        @(tanlanganGuruh?.Kurs?.Nomi ?? "Kurs")
                    </span>
                </p>
            }
        </div>

        <div class="flex flex-wrap gap-3">
            <a href="@Url.Action("Index", "Imtihon", new { guruhId = tanlanganGuruh?.Id })"
               class="inline-flex items-center px-5 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-sm font-medium">
                Imtihonlar
            </a>
            @if (tanlanganGuruh != null)
            {
                var attendanceDisabled = !talabalar.Any();
                <button type="button"
                        id="openAttendanceModal"
                        class="inline-flex items-center px-5 py-2 rounded-lg text-sm font-medium transition-colors @(attendanceDisabled ? "bg-gray-200 text-gray-500 cursor-not-allowed" : "bg-green-500 text-white hover:bg-green-600")"
                        @(attendanceDisabled ? "disabled" : null)
                        title="@(attendanceDisabled ? "Guruhda talaba yo'q" : "Davomat olish")">
                    <span id="attendanceButtonText">Davomat olish</span>
                </button>
            }
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm px-5 py-4 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex items-center gap-3 text-sm text-gray-500">
            <span>Oy bo'yicha ko'rish</span>
            <div class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2z" />
                </svg>
                <span class="text-sm text-gray-700 font-medium">
                    @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(month) / @year
                </span>
            </div>
        </div>

        <div class="flex items-center gap-2">
            @if (tanlanganGuruh != null)
            {
                <a href="@Url.Action("Groups", "Oqituvchi", new { id = tanlanganGuruh.Id, month = month == 1 ? 12 : month - 1, year = month == 1 ? year - 1 : year })"
                   class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
            }
            @if (tanlanganGuruh != null)
            {
                <a href="@Url.Action("Groups", "Oqituvchi", new { id = tanlanganGuruh.Id, month = month == 12 ? 1 : month + 1, year = month == 12 ? year + 1 : year })"
                   class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </a>
            }
        </div>
    </div>

    <!-- Course Cards -->
    @if (guruhlar.Any())
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            @foreach (var guruh in guruhlar)
            {
                var talabalarSoni = guruh.TalabaGuruhlar?.Count ?? 0;
                var vaqt = guruh.DarsVaqti.ToString("HH:mm");
                var isActive = tanlanganGuruh?.Id == guruh.Id;
                
                <a href="@Url.Action("Groups", "Oqituvchi", new { id = guruh.Id, month = month, year = year })"
                   class="course-card block p-4 border-2 rounded-lg transition-all @(isActive ? "bg-blue-500 border-blue-500 text-white" : "bg-white border-gray-200 hover:border-gray-300 text-gray-800")">
                    <div class="flex flex-col gap-1">
                        <div class="font-semibold truncate">
                            @(guruh.Kurs?.Nomi ?? "Kurs")
                        </div>
                        <div class="text-sm @(isActive ? "text-white/90" : "text-gray-600")">
                            @vaqt ¬∑ @talabalarSoni st
                        </div>
                    </div>
                </a>
            }
        </div>
    }

    <!-- Group content -->
    @if (tanlanganGuruh != null)
    {
        @if (talabalar.Any())
        {
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs md:text-sm font-semibold text-gray-700">#</th>
                            <th class="px-4 py-3 text-left text-xs md:text-sm font-semibold text-gray-700">Talaba</th>
                            <th class="px-4 py-3 text-left text-xs md:text-sm font-semibold text-gray-700">Status</th>
                            <th class="px-4 py-3 text-left text-xs md:text-sm font-semibold text-gray-700">Kelgan darslar</th>
                            @foreach (var sana in darsKunlari)
                            {
                                <th class="px-3 py-3 text-center text-xs md:text-sm font-semibold text-gray-700 whitespace-nowrap">
                                    @sana.ToString("dd.MM")
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @for (int i = 0; i < talabalar.Count; i++)
                        {
                            var talaba = talabalar[i];
                            var talabaDavomatlar = davomatlar.Where(d => d.TalabaId == talaba.Id).ToList();

                            var status = talaba.Faolmi ? "Faol" : "Guruhda";
                            var statusColor = talaba.Faolmi ? "bg-green-100 text-green-800" : "bg-blue-100 text-blue-800";

                            var sca = talabaDavomatlar.Count(d => d.Holati == "Keldi" || d.Holati == "Kech keldi");

                            <tr class="hover:bg-gray-50 student-row">
                                <td class="px-4 py-3 text-xs md:text-sm text-gray-700">@(i + 1)</td>
                                <td class="px-4 py-3">
                                    <span class="text-sm text-gray-800 font-medium">
                                        @talaba.Ism @talaba.Familiya
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium @statusColor">
                                        @status
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-xs md:text-sm text-gray-700">@sca</td>
                                @foreach (var sana in darsKunlari)
                                {
                                    var davomat = talabaDavomatlar.FirstOrDefault(d => d.Sana.Date == sana.Date);
                                    <td class="px-3 py-3 text-center">
                                        @if (davomat != null)
                                        {
                                            if (davomat.Holati == "Keldi")
                                            {
                                                <svg class="w-5 h-5 text-green-500 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 00-1.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            }
                                            else if (davomat.Holati == "Kech keldi")
                                            {
                                                <svg class="w-5 h-5 text-orange-500 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 00-1.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            }
                                            else
                                            {
                                                <span class="text-red-500">‚úó</span>
                                            }
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
                <p class="text-gray-500">Bu guruhda hozircha talabalar yo'q.</p>
            </div>
        }
    }
    else
    {
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
            <p class="text-gray-500">Guruh tanlang yoki guruhlar mavjud emas.</p>
        </div>
    }
</div>

@if (tanlanganGuruh != null && talabalar.Any())
{
    <div id="attendanceModal" class="fixed inset-0 z-50 flex items-center justify-center px-4 py-8 bg-black/50 hidden">
        <div id="attendanceModalBackdrop" class="absolute inset-0"></div>
        <div class="relative bg-white w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl border border-gray-200">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Guruh: @tanlanganGuruh.Nomi</p>
                    <h3 class="text-lg font-semibold text-gray-800">Davomat olish</h3>
                </div>
                <button type="button" id="attendanceModalClose" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500">
                    ‚úï
                </button>
            </div>

            <div class="px-6 py-4 space-y-5">
                <div class="flex flex-col lg:flex-row lg:items-end gap-4">
                    <div class="flex-1">
                        <label for="attendance-date" class="block text-sm font-medium text-gray-600">
                            Davomat sanasi
                        </label>
                        <input type="date"
                               id="attendance-date"
                               value="@todayString"
                               class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500 bg-gray-50 border border-gray-200 rounded-lg px-4 py-2">
                        <span class="flex items-center gap-1 text-green-600">
                            <span class="text-lg">‚úî</span> Keldi
                        </span>
                        <span class="flex items-center gap-1 text-amber-500">
                            <span class="text-lg">‚è∞</span> Kech keldi
                        </span>
                        <span class="flex items-center gap-1 text-red-500">
                            <span class="text-lg">‚úñ</span> Kelmagan
                        </span>
                    </div>
                </div>

                <div id="attendanceMessage" class="message-box hidden text-sm rounded-lg px-4 py-2"></div>

                <form id="attendanceForm"
                      data-group-id="@tanlanganGuruh.Id"
                      data-save-url="@Url.Action("SaveAttendance", "Oqituvchi")"
                      data-load-url="@Url.Action("LoadAttendance", "Oqituvchi")"
                      class="space-y-4">
                    @Html.AntiForgeryToken()
                    @foreach (var talaba in talabalar.OrderBy(t => t.Ism))
                    {
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 border border-gray-200 rounded-xl px-4 py-3 student-row" data-student-id="@talaba.Id">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">@talaba.Ism @talaba.Familiya</p>
                                <p class="text-sm text-gray-500 status-label">Belgilanmagan</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" class="status-btn rounded-full w-10 h-10 flex items-center justify-center" data-status="Keldi" title="Keldi">
                                    ‚úî
                                </button>
                                <button type="button" class="status-btn rounded-full w-10 h-10 flex items-center justify-center" data-status="Kech keldi" title="Kech keldi">
                                    ‚è∞
                                </button>
                                <button type="button" class="status-btn rounded-full w-10 h-10 flex items-center justify-center" data-status="Kelmadi" title="Kelmagan">
                                    ‚úñ
                                </button>
                            </div>
                            <!-- Baho qo'yish ("Keldi" va "Kech keldi" holatlarida ko'rinadi) -->
                            <div class="baho-container hidden flex items-center gap-2">
                                <label class="text-sm text-gray-600">Baho:</label>
                                <select class="baho-select px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-student-id="@talaba.Id">
                                    <option value="">Tanlang</option>
                                    <option value="10">10%</option>
                                    <option value="20">20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                            </div>
                        </div>
                    }

                    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between pt-4 border-t border-gray-100">
                        <p class="text-sm text-gray-500">Saqlangach ota-onalarga Telegram orqali avtomatik xabar yuboriladi.</p>
                        <div class="flex items-center gap-3">
                            <button type="button" id="attendanceModalCancel" class="px-4 py-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50">
                                Bekor qilish
                            </button>
                            <button type="submit"
                                    id="attendanceButtonText"
                                    class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors">
                                Saqlash
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Modal elements
            const modal = document.getElementById('attendanceModal');
            const modalBackdrop = document.getElementById('attendanceModalBackdrop');
            const modalClose = document.getElementById('attendanceModalClose');
            const modalCancel = document.getElementById('attendanceModalCancel');
            const openModalBtn = document.getElementById('openAttendanceModal');
            const attendanceButtonText = document.getElementById('attendanceButtonText');

            // Form elements
            const form = document.getElementById('attendanceForm');
            const dateInput = document.getElementById('attendance-date');
            const messageBox = document.getElementById('attendanceMessage');
            const token = form.querySelector('input[name="__RequestVerificationToken"]').value;
            const groupId = form.dataset.groupId;
            const loadUrl = form.dataset.loadUrl;
            const saveUrl = form.dataset.saveUrl;

            // Status colors
            const statusColors = {
                'Keldi': 'text-green-600',
                'Kech keldi': 'text-amber-500',
                'Kelmadi': 'text-red-500'
            };

            // Message functions
            function setMessage(text, type) {
                if (!messageBox) {
                    console.error('Message box element is null');
                    return;
                }
                messageBox.textContent = text;
                messageBox.classList.remove('hidden', 'bg-green-50', 'text-green-700', 'bg-red-50', 'text-red-700', 'bg-blue-50', 'text-blue-700', 'bg-yellow-50', 'text-yellow-700', 'bg-gray-50', 'text-gray-700');
                
                if (type === 'success') {
                    messageBox.classList.add('bg-green-50', 'text-green-700');
                } else if (type === 'error') {
                    messageBox.classList.add('bg-red-50', 'text-red-700');
                } else if (type === 'info') {
                    messageBox.classList.add('bg-blue-50', 'text-blue-700');
                } else if (type === 'warning') {
                    messageBox.classList.add('bg-yellow-50', 'text-yellow-700');
                } else {
                    messageBox.classList.add('bg-gray-50', 'text-gray-700');
                }
            }

            function resetMessage() {
                if (!messageBox) {
                    console.error('Message box element is null');
                    return;
                }
                messageBox.classList.add('hidden');
                messageBox.textContent = '';
            }

            function showLoading(isLoading = true) {
                if (attendanceButtonText) {
                    if (isLoading) {
                        attendanceButtonText.innerHTML = '<span class="loading-spinner"></span> Yuklanmoqda...';
                        attendanceButtonText.disabled = true;
                    } else {
                        attendanceButtonText.innerHTML = 'Davomat olish';
                        attendanceButtonText.disabled = false;
                    }
                } else {
                    console.warn('attendanceButtonText element not found');
                }
            }

            function updateSectionParam(isOpen) {
                const url = new URL(window.location.href);
                if (isOpen) {
                    url.searchParams.set('section', 'MarkAttendance');
                } else {
                    url.searchParams.delete('section');
                }
                window.history.replaceState({}, document.title, url);
            }

            function openModal() {
                if (!modal) {
                    updateSectionParam(false);
                    return;
                }
                modal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                updateSectionParam(true);
            }

            function closeModal() {
                if (!modal) return;
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                updateSectionParam(false);
                resetMessage();
            }

            // Event listeners
            if (openModalBtn) {
                openModalBtn.addEventListener('click', openModal);
            }
            if (modalClose) {
                modalClose.addEventListener('click', closeModal);
            }
            if (modalCancel) {
                modalCancel.addEventListener('click', closeModal);
            }
            if (modalBackdrop) {
                modalBackdrop.addEventListener('click', closeModal);
            }
            document.addEventListener('keydown', (evt) => {
                if (evt.key === 'Escape') {
                    closeModal();
                }
            });

            const shouldAutoOpen = '@(autoOpenModal ? "true" : "false")' === 'true';
            if (shouldAutoOpen) {
                openModal();
            }

            // Status setting function
            function setRowStatus(row, status) {
                if (!row) {
                    console.error('Row element is null');
                    return;
                }
                
                row.dataset.selectedStatus = status || '';
                const label = row.querySelector('.status-label');
                if (!label) {
                    console.error('Status label not found in row:', row);
                    return;
                }
                label.textContent = status || 'Belgilanmagan';
                label.className = 'text-sm status-label ' + (status ? `font-semibold ${statusColors[status] ?? 'text-gray-600'}` : 'text-gray-400');
                
                // Update button states
                row.querySelectorAll('.status-btn').forEach(button => {
                    button.classList.toggle('active', button.dataset.status === status);
                });
                
                // Show/hide grade container
                const bahoContainer = row.querySelector('.baho-container');
                if (bahoContainer) {
                    if (status === 'Keldi' || status === 'Kech keldi') {
                        bahoContainer.classList.remove('hidden');
                    } else {
                        bahoContainer.classList.add('hidden');
                        const bahoSelect = row.querySelector('.baho-select');
                        if (bahoSelect) {
                            bahoSelect.value = '';
                        }
                    }
                }
            }

            // Initialize status buttons
            document.querySelectorAll('#attendanceForm [data-student-id]').forEach(row => {
                row.querySelectorAll('.status-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        setRowStatus(row, button.dataset.status);
                    });
                });
            });

            // Load attendance data function
            async function loadAttendanceData() {
                resetMessage();
                showLoading(true);
                
                // Validate parameters
                if (!loadUrl || !groupId || !dateInput || !dateInput.value) {
                    const missingParams = [];
                    if (!loadUrl) missingParams.push('loadUrl');
                    if (!groupId) missingParams.push('groupId');
                    if (!dateInput) missingParams.push('dateInput element');
                    if (!dateInput?.value) missingParams.push('date value');
                    
                    setMessage(`‚ùå Parametrlar topilmadi: ${missingParams.join(', ')}`, 'error');
                    console.error('Missing parameters:', { loadUrl, groupId, dateInput: dateInput?.value });
                    showLoading(false);
                    return;
                }
                
                try {
                    setMessage('üìä Ma\'lumotlar yuklanmoqda...', 'info');
                    
                    const url = `${loadUrl}?guruhId=${encodeURIComponent(groupId)}&sana=${encodeURIComponent(dateInput.value)}`;
                    console.log('Loading attendance:', { groupId, date: dateInput.value, url });
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    console.log('Response received:', response.status);
                    
                    if (!response.ok) {
                        let errorMessage = 'Ma\'lumotni yuklashda xatolik.';
                        try {
                            const errorText = await response.text();
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.message || errorMessage;
                        } catch (e) {
                            errorMessage = `Server xatosi: ${response.status}`;
                        }
                        setMessage(errorMessage, 'error');
                        showLoading(false);
                        return;
                    }

                    const text = await response.text();
                    if (!text) {
                        setMessage('Serverdan bo\'sh javob keldi.', 'error');
                        showLoading(false);
                        return;
                    }
                    
                    const data = JSON.parse(text);
                    if (data.success) {
                        // Reset all rows first
                        document.querySelectorAll('#attendanceForm [data-student-id]').forEach(row => {
                            setRowStatus(row, '');
                            const bahoSelect = row.querySelector('.baho-select');
                            if (bahoSelect) bahoSelect.value = '';
                        });
                        
                        // Set data for each student
                        data.students.forEach(item => {
                            const row = document.querySelector(`#attendanceForm [data-student-id="${item.talabaId}"]`);
                            if (row) {
                                setRowStatus(row, item.holat || '');
                                if (item.baho !== undefined && item.baho !== null) {
                                    const bahoSelect = row.querySelector('.baho-select');
                                    if (bahoSelect) {
                                        bahoSelect.value = item.baho.toString();
                                    }
                                }
                            } else {
                                console.warn(`Row not found for student ID: ${item.talabaId}`);
                            }
                        });
                        
                        setMessage(`‚úÖ ${data.students.length} talaba ma\'lumoti yuklandi`, 'success');
                    } else {
                        setMessage(data.message || 'Ma\'lumotni yuklashda xatolik.', 'error');
                    }
                } catch (err) {
                    console.error('Network error:', err);
                    console.error('Error details:', {
                        name: err.name,
                        message: err.message,
                        stack: err.stack
                    });
                    if (err.name === 'AbortError') {
                        setMessage('‚è∞ Server javob berishda sekinlik bor.', 'warning');
                    } else if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
                        setMessage('üåê Internet aloqasini tekshiring.', 'error');
                    } else {
                        setMessage(`üåê Xato: ${err.message}`, 'error');
                    }
                } finally {
                    showLoading(false);
                }
            }

            // Save attendance function
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                resetMessage();
                showLoading(true);

                // Validate parameters
                if (!saveUrl || !groupId || !dateInput || !dateInput.value || !token) {
                    const missingParams = [];
                    if (!saveUrl) missingParams.push('saveUrl');
                    if (!groupId) missingParams.push('groupId');
                    if (!dateInput) missingParams.push('dateInput element');
                    if (!dateInput?.value) missingParams.push('date value');
                    if (!token) missingParams.push('security token');
                    
                    setMessage(`‚ùå Parametrlar topilmadi: ${missingParams.join(', ')}`, 'error');
                    showLoading(false);
                    return;
                }

                // Collect form data
                const talabalar = Array.from(document.querySelectorAll('#attendanceForm [data-student-id]'))
                    .map(row => {
                        const holati = row.dataset.selectedStatus || '';
                        const bahoSelect = row.querySelector('.baho-select');
                        const baho = bahoSelect && bahoSelect.value ? parseInt(bahoSelect.value) : null;
                        return {
                            talabaId: Number(row.dataset.studentId),
                            holati: holati,
                            baho: baho
                        };
                    });

                // Check if at least one student has status
                const tanlanganTalabalar = talabalar.filter(item => item.holati);
                if (!tanlanganTalabalar.length) {
                    setMessage('Hech bo‚Äòlmasa bitta talaba uchun holat tanlang.', 'error');
                    showLoading(false);
                    return;
                }

                const payload = {
                    guruhId: Number(groupId),
                    sana: dateInput.value,
                    talabalar
                };

                try {
                    setMessage('üíæ Davomat saqlanmoqda...', 'info');
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000);
                    
                    const response = await fetch(saveUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    console.log('Save response:', response.status);
                    
                    if (!response.ok) {
                        let errorMessage = 'Davomatni saqlashda xatolik.';
                        try {
                            const errorText = await response.text();
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.message || errorMessage;
                        } catch (e) {
                            errorMessage = `Server xatosi: ${response.status}`;
                        }
                        setMessage(errorMessage, 'error');
                        showLoading(false);
                        return;
                    }

                    const text = await response.text();
                    if (!text) {
                        setMessage('‚úÖ Davomat saqlandi!', 'success');
                        await loadAttendanceData();
                        return;
                    }
                    
                    const data = JSON.parse(text);
                    if (data.success) {
                        setMessage(`‚úÖ ${data.updated || tanlanganTalabalar.length} ta davomat saqlandi!`, 'success');
                        await loadAttendanceData();
                    } else {
                        setMessage(data.message || 'Davomatni saqlashda xatolik.', 'error');
                    }
                } catch (err) {
                    console.error('Save error:', err);
                    if (err.name === 'AbortError') {
                        setMessage('‚è∞ Server javob berishda sekinlik bor.', 'warning');
                    } else {
                        setMessage('üåê Server bilan aloqa o\'rnatilmadi.', 'error');
                    }
                } finally {
                    showLoading(false);
                }
            });

            // Load initial data and set up date change listener
            loadAttendanceData();
            dateInput.addEventListener('change', loadAttendanceData);
        });
    </script>
}

